version: "3"

# The following must be set either in environment variables or via a .env file in the same folder as this file:
#
# AGENT_PATH      host path to the Agent linux home folder - will map to /usr/local/newrelic-dotnet-agent in the container
# LOG_PATH        host path for Agent logfile output - will map to /app/logs in the container
# PORT            external port for the lambda invoke API (endpoint is /2015-03-31/functions/function/invocations)
# CONTAINER_NAME  The name for the container
# 
# and the usual suspects:
# NEW_RELIC_LICENSE_KEY
# NEW_RELIC_APP_NAME
#
#
# To build and run, execute `docker compose -f <path to docker-compose.yml> up` 
# Alternatively, set COMPOSE_FILE environment variable to the path and omit the -f parameter

services:
    LinuxSmokeTestApp:
        container_name: ${CONTAINER_NAME}
        image: ${CONTAINER_NAME}
        build:
            context: ./LambdaFunctionTestApp
            dockerfile: Dockerfile
            args:
                NEW_RELIC_LICENSE_KEY: ${NEW_RELIC_LICENSE_KEY}
                NEW_RELIC_APP_NAME: ${NEW_RELIC_APP_NAME}
            no_cache: true # this may be temporary
        ports:
          - "${PORT}:8080"
        volumes:
          - ${AGENT_PATH}:/usr/local/newrelic-dotnet-agent # AGENT_PATH from .env, points to newrelichome_linux_x64
          - ${LOG_PATH}:/app/logs # LOG_PATH from .env, should be a folder unique to this run of the smoketest app
networks:
    default:
        driver: bridge
        driver_opts:
          com.docker.network.bridge.enable_icc: "true"
